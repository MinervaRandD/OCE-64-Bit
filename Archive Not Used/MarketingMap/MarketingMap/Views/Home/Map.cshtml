@{
    ViewData["Title"] = "Marketing Map";
}

<!DOCTYPE html>
<html lang="en">
   
<head>
	<style>
		#googleMap{
			height:800px;
			width:100%
		}
	</style>

    <meta charset="UTF-8">
    <meta name="description" content="Marketing Map">
    <meta name="keywords" content="Market Marketing Map">
    <meta name="author" content="Marc Diamond;Minerva Research and Development LLC">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

</style>

</head>

<body>

<h1 style="text-align:center;color:maroon;">Marketing Manager</h1>

<input id="pac-input" class="controls" placeholder="Search" type="text" style="height:40px;width:256px;margin-top:8px;border:none;font-size:16px;">

<div class="container-fluid">
    <div class='row' style="width:100%;min-width:100%;margin-top:64px;">
        <div class='col-3'>
            <div style="text-align:center;border:solid;border-color:maroon;padding:48px;border-width:4px;border-radius:24px;margin:4px;">
                
            </div>
        </div>

        <div class='col-9' >
            <div style="border:solid;border-color:maroon;padding:48px;border-width:4px;border-radius:24px;margin:4px;">
                <div id="googleMap"/>
            </div>
        </div>
    </div>
</div>

<script async defer>

var map;

function init() {

  
	var mapProp= {
	  center:new google.maps.LatLng(@ViewBag.initialLocation.Item1, @ViewBag.initialLocation.Item2),
	  zoom:14,
      fullscreenControl: false
	};

	map = new google.maps.Map(document.getElementById("googleMap"),mapProp);

    const homeButton = createHomeIcon(map);

    // Create the DIV to hold the control.
    const homeControlDiv = document.createElement("div");

    homeControlDiv.style.marginRight = "8px";

    // Create the control.
    const homeControl = createHomeIcon();

    // Append the control to the DIV.

    homeControlDiv.appendChild(homeControl);

    map.controls[google.maps.ControlPosition.TOP_RIGHT].push(homeControlDiv);

    map.addListener('dragend', mapDragendEventHandler);
   
   @foreach (Marker marker in ViewBag.markerList)
        {
            @:addExistingMarker('@marker.MarkerId', @marker.Lat, @marker.Lng, map);
        }

   map.addListener('rightclick', mapRightClickListener);

   
   var searchBox = new google.maps.places.SearchBox(document.getElementById('pac-input'));
   map.controls[google.maps.ControlPosition.TOP_CENTER].push(document.getElementById('pac-input'));
 
    searchBox.set('map', map);

   google.maps.event.addListener(searchBox, 'places_changed', function() {
     searchBox.set('map', null);


     var places = searchBox.getPlaces();

    
     var bounds = new google.maps.LatLngBounds();
     var i, place;
     for (i = 0; place = places[i]; i++) {
       (function(place) {
         
         bounds.extend(place.geometry.location);


       }(place));

     }
     map.fitBounds(bounds);
     searchBox.set('map', map);
     map.setZoom(Math.min(map.getZoom(),12));

   });
}

function createHomeIcon()
{
    const controlImage = document.createElement("img");

  // Set CSS for the control.
  controlImage.style.backgroundColor = "#fff";
  controlImage.style.border = "2px solid #fff";
  controlImage.style.borderRadius = "3px";
  controlImage.style.boxShadow = "0 2px 6px rgba(0,0,0,.3)";
  controlImage.style.color = "rgb(25,25,25)";
  controlImage.style.cursor = "pointer";
  controlImage.style.fontFamily = "Roboto,Arial,sans-serif";
  controlImage.style.fontSize = "16px";
  controlImage.style.lineHeight = "38px";
  controlImage.style.margin = "8px 0 22px";
  controlImage.style.padding = "0 5px";
  controlImage.style.textAlign = "center";

  controlImage.src="/img/HomeIcon.png";

  controlImage.style.height="40px";
  controlImage.style.width="48px";

  controlImage.title = "Click to home map";
  controlImage.type = "button";
 
  controlImage.addEventListener("click", () => {
    moveMapHome();
  });

  return controlImage;
}

function createSearchBox(map)
{
     
}

function mapRightClickListener(mapsMouseEvent)
{
     addMarker(mapsMouseEvent.latLng, 'title', this);
}

function mapDragendEventHandler()
{
   recordMapCurrentCenter(this.center.lat(), this.center.lng());
}

function moveMapHome()
{
    map.setCenter(new google.maps.LatLng(@StaticGlobals.homeLat, @StaticGlobals.homeLng));

    recordMapCurrentCenter(@StaticGlobals.homeLat, @StaticGlobals.homeLng);
}

function recordMapCurrentCenter(lat, lng)
{
    var request = new XMLHttpRequest;

    request.open('POST', 'Home/MapMoved', true);

    request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    request.send('lat=' + lat + '&lng=' + lng);
}

function markerDragendEventHandler()
{
   var request = new XMLHttpRequest;

   request.open('POST', 'Marker/MarkerMoved', true);

   request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

   request.send('tag=' + this.Tag + '&lat=' + this.position.lat() + '&lng=' + this.position.lng());
    
}

function addMarker(latlng,title,map) {

    var marker = new google.maps.Marker({
            position: latlng,
            map: map,
            title: title,
            draggable:true
    });

    var request = new XMLHttpRequest;

    request.open('POST', 'Marker/MarkerAdded', false);

    request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    request.send('lat=' + latlng.lat() + '&lng=' + latlng.lng());
  
    console.log('Tag=' + request.responseText);

    marker.Tag = request.responseText;

    marker.addListener('dragend', markerDragendEventHandler);

    marker.addListener('rightclick', () => showInfoWindow(marker));

    marker.addListener('mouseover', () => showInfoWindow(marker));
    
    marker.addListener('mouseout', () => closeInfoWindow());

    return marker;
}


function addExistingMarker(tag, lat, lng, map)
{    
     var position = new google.maps.LatLng(lat, lng);
  
    var marker = new google.maps.Marker({
            position: position,
            map: map,
            title: 'hello',
            Tag: tag,
            draggable:true
    });
    
    marker.addListener('dragend', markerDragendEventHandler);

    marker.addListener('rightclick', () => showInfoWindow(marker));

    marker.addListener('mouseover', () => showInfoWindow(marker));
    
    marker.addListener('mouseout', () => closeInfoWindow(marker));
}

var currInfoWindow;


function showInfoWindow(marker)
{
    console.log('showing info window ' + marker.position);

    currInfoWindow = new google.maps.InfoWindow({
        content: 'hello there sailor',
        });

    
    currInfoWindow.open({anchor: marker, map});
}

function closeInfoWindow(marker)
{
    console.log('close info window');

    currInfoWindow.close();
}

function myFunction()
{
    showInfoWindow();
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-jLPWizd03XJiemr6BXsBm2ktU1Bii8c&callback=init&libraries=places" defer></script>

</body>
</html>
