@{
    ViewData["Title"] = "Marketing Map";
}

<!DOCTYPE html>
<html lang="en">
   
<head>
	<style>
		#googleMap{
			height:800px;
			width:100%
		}

	</style>

    <meta charset="UTF-8">
    <meta name="description" content="Marketing Map">
    <meta name="keywords" content="Market Marketing Map">
    <meta name="author" content="Marc Diamond;Minerva Research and Development LLC">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    
    button.gm-ui-hover-effect {
        visibility: hidden;
        }
</style>

</head>

<body>

<h1 style="text-align:center;color:maroon;">Marketing Manager</h1>

<input id="pac-input" class="controls" placeholder="Search" type="text" style="height:40px;width:256px;margin-top:8px;border:none;font-size:16px;">

<div class="container-fluid">
    <div class='row' style="width:100%;min-width:100%;margin-top:64px;">
        <div class='col-4'>
            <div style="text-align:center;border:solid;border-color:maroon;padding:48px;border-width:4px;border-radius:24px;margin:4px;height:100%">
                <h3 style="margin-top:-69px;margin-left:5px;background:white;width:128px">Contacts</h3>
                <div style="height:32px"></div>
                
                <table class="table table-striped table-bordered table-hover">
                    <tbody id="ContactList"></tbody>
                </table>
            </div>
        </div>

        <div class='col-8' >
            <div style="border:solid;border-color:maroon;padding:48px;border-width:4px;border-radius:24px;margin:4px;">
                <h3 style="margin-top:-69px;margin-left:5px;background:white;width:68px;text-align:center">Map</h3>
                <div id="googleMap"  />
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../lib/local/map.js"></script>
<script type="text/javascript" src="../lib/local/common.js"></script>
<script type="text/javascript" src="../lib/local/location.js"></script>
<script type="text/javascript" src="../lib/local/marker.js"></script>
<script type="text/javascript" src="../lib/local/contact.js"></script>

<script async defer>

var userId;

function allowDrop(ev) {
     
    console.log('allowDrop');

    ev.preventDefault();
}

function drag(ev) {
  ev.dataTransfer.setData("text", ev.target.id);
}

function drop(ev) {
  ev.preventDefault();
  var data = ev.dataTransfer.getData("text");
  ev.target.appendChild(document.getElementById('text'));
}

function editContact(contactId)
{
    console.log('editing ' + contactId)
}

function init()
{

	let position = new google.maps.LatLng(@ViewBag.initialLocation.Item1, @ViewBag.initialLocation.Item2);

    homeLat = @ViewBag.homeLat;
    homeLng = @ViewBag.homeLng;

    initializeMap(position);
    initializeLocationMap();
    initializeMarkerMap();
    initializeContactMap();
    
    document.getElementById('ContactList').innerHTML = generateContactTable();

    codeAddress();
}

function initializeLocationMap()
{
    locationMap.clear();

    @foreach(Location location in ViewBag.locationList)
        {
            @:var locationInstance = new locationClass(
                @: '@location.UserId',
                @: '@location.LocationId',
                @: '@location.Lat',
                @: '@location.Lng',
                @: '@location.LocationName',
                @: '@location.Comments',
                @:);
                   
            @:locationMap.set('@location.LocationId', locationInstance);

        }
}

function initializeMarkerMap()
{
    markerMap.clear();

    @foreach(Marker marker in ViewBag.markerList)
        {
            @:var markerInstance = new markerClass(
                @: '@marker.UserId',
                @: '@marker.MarkerId',
                @: '@marker.ContactId',
                @: '@marker.LocationId',
                @: '@marker.ImageId'
                @:);

            @:markerMap.set('@marker.MarkerId', marker);

        }
}

function initializeContactMap()
{
    contactMap.clear();

    @foreach (Contact contact in ViewBag.contactList)
        {
    
            @:var contactInstance = new contactClass(
                @: '@contact.UserId',
                @: '@contact.ContactId',
                @: '@contact.PointOfContact',
                @: '@contact.CompanyName',
                @: '@contact.CompanyAddress1',
                @: '@contact.CompanyAddress2',
                @: '@contact.CompanyCity',
                @: '@contact.CompanyStateOrRegion',
                @: '@contact.CompanyCountry',
                @: '@contact.CompanyPostalCode',
                @: '@contact.ContactPhone',
                @: '@contact.ContactEmail',
                @: '@contact.ContactWebSite',
                @: '@contact.Comments',
                @: '@contact.MarkerId',
                @: '@contact.LocationId',
                @: '@contact.Status'
                @:);

            @:contactMap.set('@contact.ContactId', contactInstance);
        }
}

function recordMapCurrentCenter(lat, lng)
{
    let request = new XMLHttpRequest;

    request.open('POST', 'Home/MapMoved', true);

    request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    request.send('lat=' + lat + '&lng=' + lng);
}



function addExistingMarker(markerId, lat, lng, contactId, map)
{    
     let position = new google.maps.LatLng(lat, lng);
  
    let marker = new google.maps.Marker({
            markerId: markerId,
            position: position,
            map: map,
            contactId: contactId,
            draggable:true
    });

    marker.addListener('dragend', () => markerDragendEventHandler(marker));

    marker.addListener('rightclick', () => showInfoWindow(marker));

    marker.addListener('mouseover', () => showInfoWindow(marker));
    
    marker.addListener('mouseout', () => closeInfoWindow(marker));

    markerMap.set(marker.markerId, marker);
}

function codeAddress() {
    geocoder = new google.maps.Geocoder();
    //In this case it gets the address from an element on the page, but obviously you  could just pass it to the method instead
    
    geocoder.geocode( { 'address' : '7291 Demedici Circle, Delray Beach, FL, 33446' }, function( results, status ) {

        console.log('Geocoder status = ' + status);
        if( status == google.maps.GeocoderStatus.OK ) {

            //In this case it creates a marker, but you can get the lat and lng from the location.LatLng
            map.setCenter( results[0].geometry.location );
            var marker = new google.maps.Marker( {
                map     : map,
                position: results[0].geometry.location
            } );
        } else {
            alert( 'Geocode was not successful for the following reason: ' + status );
        }
    } );
}

function generateContactTable() {

    var contactTable = '';

    contactMap.forEach(function (value, key) {

        console.log(key + ' ' + value.companyName);

        contactTable += '<tr>';

        if (value.markerId) // Contact has a marker associated with it.
        {
            contactTable += '<td id="pin-' + key + '"><img src="img/RedLocationPin.png" draggable="false" style="user-select:none;height:24px"/></td>';
        }

        else {
            contactTable += '<td id="pin-' + key + '"><img src="img/WhiteLocationPin.png" draggable="true" ondragstart="pinDragStart(\'' + key + '\')" style="height:24px"/></td>';
        }

        contactTable += '<td style="user-select:none">' + value.companyName + '</td>';
        contactTable += '<td style="width:28px"><img src="img/EditIcon.png" title="Click to edit contact ' + value.companyName + '" style="user-select:none;" onclick="editContact(\'' + key + '\')" /></td>';
        contactTable += '<td style="width:28px"><img src="img/DeleteIcon.png" title="Click to delete contact ' + value.companyName + '" style="user-select:none" onclick="deleteContact(\'' + key + '\')" /></td>';
        contactTable += '<td style="width:28px;"><img src="img/TargetIcon.png" title="Click to center map on ' + value.companyName + '\'s location" style="height:24px;width:24px;user-select:none" onclick="moveMapToPin(\'' + key + '\')"/></td>';
        contactTable += '</tr>'
    });

    return contactTable;
}

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-jLPWizd03XJiemr6BXsBm2ktU1Bii8c&callback=init&libraries=places" defer></script>

</body>
</html>
